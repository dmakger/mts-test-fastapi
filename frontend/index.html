<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сотрудники и подразделения</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
    <style>
        .ui-tabs-panel {
            padding: 20px;
        }
        .dataTables_wrapper {
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div id="tabs">
    <ul>
        <li><a href="#tabs-1">Список сотрудников на дату</a></li>
        <li><a href="#tabs-2">Состав подразделений</a></li>
    </ul>
    <div id="tabs-1">
        <form id="dateForm">
            <label for="reportDate">Отчет на дату:</label>
            <input type="text" id="reportDate" name="reportDate">
        </form>
        <table id="employeesTable" class="display">
            <thead>
                <tr>
                    <th>ФИО</th>
                    <th>Должность</th>
                    <th>Подразделение</th>
                    <th>Дата приема</th>
                    <th>Дата увольнения</th>
                    <th>Зарплата</th>
                </tr>
            </thead>
            <tbody>
                <!-- Данные будут загружены через DataTables -->
            </tbody>
        </table>
    </div>
    <div id="tabs-2">
        <form id="divisionForm">
            <label for="divisions">Отдел:</label>
            <select id="divisions" name="divisions[]" multiple="multiple" style="width: 300px;">
                <!-- Опции будут загружены через Select2 -->
            </select>
        </form>
        <table id="divisionsTable" class="display">
            <thead>
                <tr>
                    <th>ФИО</th>
                    <th>Должность</th>
                    <th>Подразделение</th>
                    <th>Дата приема</th>
                    <th>Дата увольнения</th>
                    <th>Зарплата</th>
                </tr>
            </thead>
            <tbody>
                <!-- Данные будут загружены через DataTables -->
            </tbody>
        </table>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
    // Инициализация Tabs
    $("#tabs").tabs({
        active: 1
    });

    // Инициализация DatePicker
    $("#reportDate").datepicker({
        dateFormat: "yy-mm-dd",
        maxDate: 0
    });

    // Инициализация Select2
    $("#divisions").select2();

    // Запрос на получение данных сотрудников
    async function fetchEmployeesData(reportDate = null, divisions = []) {
        try {
            const url = new URL("http://localhost:8000/api/v1/employees/all"); // Убедитесь, что это правильный URL вашего API
            const params = new URLSearchParams();

            if (reportDate) {
                params.append("reportDate", reportDate);
            }

            if (divisions.length > 0) {
                params.append("divisions", JSON.stringify(divisions));
            }

            url.search = params.toString();

            const response = await fetch(url, {
                method: "GET", // Тип запроса
                headers: {
                    "Content-Type": "application/json",
                },
            });

            // Проверяем, успешен ли запрос
            if (!response.ok) {
                throw new Error(`Error fetching employees: ${response.statusText}`);
            }

            // Извлекаем данные из ответа
            const employeesData = await response.json();
            return employeesData; // Возвращаем данные для дальнейшего использования

        } catch (error) {
            console.error("Error in fetchEmployeesData:", error);
            throw error; // Перехватываем и пробрасываем ошибку
        }
    }

    // Получение данных сотрудников при загрузке страницы
    async function loadEmployees() {
        try {
            // Получаем данные сотрудников без фильтров по умолчанию
            const employeesData = await fetchEmployeesData();

            // Заполняем таблицу сотрудников
            const employeesTable = $('#employeesTable').DataTable({
                data: employeesData,
                columns: [
                    { data: 'fio' },
                    { data: 'position' },
                    { data: 'division' },
                    { data: 'hire_date' },
                    { data: 'dismissal_date' },
                    { data: 'salary' }
                ]
            });

            // Заполняем Select2
            const divisionsData = Array.from(new Set(employeesData.map(emp => emp.division))); // Извлекаем уникальные подразделения
            divisionsData.forEach(division => {
                $("#divisions").append(new Option(division, division));
            });

        } catch (error) {
            console.error("Error loading employees:", error);
        }
    }

    // Инициализация данных сотрудников при загрузке страницы
    loadEmployees();

    // Обновление таблицы сотрудников при изменении даты
    $("#reportDate").on("change", async function() {
        const selectedDate = $(this).val();
        const selectedDivisions = $("#divisions").val() || [];

        // Получаем обновленные данные с учетом выбранной даты и подразделений
        const employeesData = await fetchEmployeesData(selectedDate, selectedDivisions);

        // Перезагружаем таблицу с новыми данными
        const employeesTable = $('#employeesTable').DataTable();
        employeesTable.clear().rows.add(employeesData).draw();
    });

    // Обновление таблицы подразделений при изменении выбора
    $("#divisions").on("change", async function() {
        const selectedDivisions = $(this).val() || [];
        const selectedDate = $("#reportDate").val();

        // Получаем обновленные данные с учетом выбранных подразделений и даты
        const employeesData = await fetchEmployeesData(selectedDate, selectedDivisions);

        // Перезагружаем таблицу с новыми данными
        const employeesTable = $('#employeesTable').DataTable();
        employeesTable.clear().rows.add(employeesData).draw();
    });
});

</script>
</body>
</html>